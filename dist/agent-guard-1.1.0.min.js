!function(){"use strict";let e,t;try{e=require("tiktoken")}catch(e){}try{t=require("@anthropic-ai/tokenizer")}catch(e){}let n={"gpt-4":{input:.03,output:.06},"gpt-4-turbo":{input:.01,output:.03},"gpt-3.5-turbo":{input:.0015,output:.002},"gpt-4o":{input:.0025,output:.01},"gpt-4o-mini":{input:15e-5,output:6e-4},"claude-3-opus":{input:.015,output:.075},"claude-3-sonnet":{input:.003,output:.015},"claude-3-haiku":{input:25e-5,output:.00125},"claude-3-5-sonnet":{input:.003,output:.015},default:{input:.01,output:.03}},o={limit:10,webhook:null,enabled:!0,silent:!1,mode:"kill",redis:null},i=0,r=!1,u=0,a=null;const s=[],c="undefined"!=typeof require?require("fs"):null,l=("undefined"!=typeof require&&require("path"),".agentguard-cache.json"),d={red:"[31m",green:"[32m",yellow:"[33m",blue:"[34m",magenta:"[35m",cyan:"[36m",white:"[37m",reset:"[0m",bold:"[1m"},p={log:console.log,fetch:"undefined"!=typeof fetch?fetch:null,exit:"undefined"!=typeof process?process.exit:null};function g(e,t){if(e.includes("openai.com")){return t?.model||"gpt-3.5-turbo"}if(e.includes("anthropic.com")){return t?.model||"claude-3-haiku"}return"default"}function f(e,t=0,o=0){const i=n[e]||n.default;return t/1e3*i.input+o/1e3*i.output}function m(n,o="gpt-3.5-turbo"){if(!n)return 0;try{if(o.includes("gpt")&&e){return e.encoding_for_model(o.startsWith("gpt-4o")?"gpt-4o":o.startsWith("gpt-4")?"gpt-4":"gpt-3.5-turbo").encode(n).length}if(o.includes("claude")&&t)return t.encode(n).length}catch(e){console.warn("AgentGuard: Tokenizer error, falling back to estimation:",e.message)}const i=n.split(/\s+/).length,r=n.length;return Math.ceil(1.3*i+.25*r)}async function h(){if(p.fetch)try{if(c&&c.existsSync&&c.existsSync(l)){const e=JSON.parse(c.readFileSync(l,"utf8")),t=36e5;if(Date.now()-e.timestamp<t)return void(n={...n,...e.prices})}const e={timestamp:Date.now(),prices:{"gpt-4":{input:.03,output:.06},"gpt-4-turbo":{input:.01,output:.03},"gpt-3.5-turbo":{input:.0015,output:.002},"gpt-4o":{input:.0025,output:.01},"gpt-4o-mini":{input:15e-5,output:6e-4},"claude-3-opus":{input:.015,output:.075},"claude-3-sonnet":{input:.003,output:.015},"claude-3-haiku":{input:25e-5,output:.00125},"claude-3-5-sonnet":{input:.003,output:.015}}};n={...n,...e.prices},c&&c.writeFileSync&&c.writeFileSync(l,JSON.stringify(e,null,2))}catch(e){console.warn("AgentGuard: Failed to update prices, using cached values:",e.message)}}async function y(e){if(a)try{const t="agentguard:budget",n=await a.incrByFloat(t,e);return await a.expire(t,86400),n}catch(e){console.warn("AgentGuard: Redis increment failed, using local tracking:",e.message)}return i+=e,i}function $(e,t){try{if(e.usage)return{input:e.usage.prompt_tokens||e.usage.input_tokens||0,output:e.usage.completion_tokens||e.usage.output_tokens||0};const n=e.choices?.[0]?.message?.content||e.content?.[0]?.text||JSON.stringify(e);return{input:.3*m(n,t),output:m(n,t)}}catch(e){return{input:100,output:100}}}function w(){const e=Date.now();if(e-u<100)return;if(u=e,o.silent)return;const t=i.toFixed(4),n=(i/o.limit*100).toFixed(1);let r="",a="";if(i>.9*o.limit?(r=`${d.red}${d.bold}$${t}${d.reset}`,a=` ${d.red}${d.bold}DANGER ${n}%${d.reset}`):i>.8*o.limit?(r=`${d.yellow}${d.bold}$${t}${d.reset}`,a=` ${d.yellow}WARNING ${n}%${d.reset}`):i>.5*o.limit?(r=`${d.cyan}$${t}${d.reset}`,a=` ${d.cyan}${n}%${d.reset}`):(r=`${d.green}$${t}${d.reset}`,a=` ${d.green}${n}%${d.reset}`),"undefined"!=typeof process){const e=`${r} / $${o.limit} ${a}`;process.stdout.write(`\r${e}${" ".repeat(Math.max(0,50-e.length))}`)}if("undefined"!=typeof document){let e=document.getElementById("agent-guard-widget");if(e||(e=document.createElement("div"),e.id="agent-guard-widget",e.style.cssText="\n          position: fixed; top: 20px; right: 20px; z-index: 99999;\n          background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);\n          color: #00ff88; padding: 12px 16px; border-radius: 8px;\n          font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;\n          font-size: 14px; font-weight: 600; letter-spacing: 0.5px;\n          box-shadow: 0 4px 20px rgba(0,0,0,0.3), 0 0 0 1px rgba(255,255,255,0.1);\n          border: 1px solid rgba(0,255,136,0.3);\n          transition: all 0.3s ease;\n        ",document.body.appendChild(e)),e.textContent=`$${t} / $${o.limit} (${n}%)`,i>.9*o.limit?(e.style.background="linear-gradient(135deg, #ff1744 0%, #f50057 100%)",e.style.color="#fff",e.style.borderColor="#ff1744",e.style.animation="pulse 1s infinite"):i>.8*o.limit&&(e.style.background="linear-gradient(135deg, #ff9800 0%, #f57c00 100%)",e.style.color="#fff",e.style.borderColor="#ff9800"),!document.getElementById("agentguard-styles")){const e=document.createElement("style");e.id="agentguard-styles",e.textContent="\n          @keyframes pulse {\n            0% { transform: scale(1); }\n            50% { transform: scale(1.05); }\n            100% { transform: scale(1); }\n          }\n        ",document.head.appendChild(e)}}}function b(e){if(r)return;r=!0;const t=`AGENTGUARD: ${e} - Saved you ~$${Math.max(0,5*o.limit-i).toFixed(2)}`;if(p.log(`\n${d.red}${d.bold}${t}${d.reset}`),p.log(`${d.cyan}Total cost when stopped: $${i.toFixed(4)}${d.reset}`),p.log(`${d.yellow}Budget used: ${(i/o.limit*100).toFixed(1)}%${d.reset}`),async function(e){if(o.webhook)try{const t={text:e,timestamp:(new Date).toISOString(),cost:i,limit:o.limit};p.fetch&&await p.fetch(o.webhook,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})}catch(e){p.log(`${d.red}AgentGuard: Webhook failed${d.reset}`,e.message)}}(t),"notify"!==o.mode){if("throw"===o.mode)throw new Error("AGENTGUARD_LIMIT_EXCEEDED: "+t);if("kill"===o.mode)if(p.exit)p.exit(1);else{if("undefined"==typeof window)throw new Error("AGENTGUARD_KILLED: "+t);alert(`${t}\nReloading page...`),window.location.reload()}}else p.log(`${d.yellow}Mode: notify - continuing execution with warning${d.reset}`)}async function x(e,t){if(e&&(e.includes("openai.com")||e.includes("anthropic.com")||e.includes("api.anthropic.com")))try{const n=g(e,t),i=$(t,n),r=f(n,i.input,i.output),u=await y(r);s.push({timestamp:Date.now(),model:n,cost:r,tokens:i,url:e}),w(),u>=o.limit&&b("COST LIMIT EXCEEDED")}catch(e){y(.01).then(()=>w()).catch(()=>{})}}function k(e){return async function(t,n={}){const i=await e.call(this,t,n);if(t&&"string"==typeof t&&(t.includes("openai.com")||t.includes("anthropic.com")||t.includes("api.anthropic.com"))){const e=i.clone();try{const i=await e.json(),r=g(t,n.body?JSON.parse(n.body):{}),u=$(i,r),a=f(r,u.input,u.output),c=await y(a);s.push({timestamp:Date.now(),model:r,cost:a,tokens:u,url:t}),w(),c>=o.limit&&b("COST LIMIT EXCEEDED")}catch(e){y(.01).then(()=>w()).catch(()=>{})}}return i}}async function E(e={}){if(o={...o,...e},!o.enabled)return;await async function(){if(o.redis)try{const e=require("redis");a=e.createClient({url:o.redis}),await a.connect()}catch(e){console.warn("AgentGuard: Redis connection failed, using local tracking:",e.message),a=null}}(),await h();const t=`${d.green}${d.bold}AgentGuard${d.reset} ${d.cyan}v1.1.0${d.reset} ${d.green}initialized${d.reset}`,n=`${d.cyan}Budget protection: $${o.limit} (mode: ${o.mode})${d.reset}`,r=(d.dim||"")+"-".repeat(50)+(d.reset||"");return p.log("\n"+r),p.log(t),p.log(n),p.log(`${d.dim||""}Monitoring: console.log, fetch, axios${d.reset||""}`),o.redis&&p.log(`${d.dim||""}Multi-process: Redis enabled${d.reset||""}`),p.log(r+"\n"),console.log=function(...e){e.forEach(e=>{if("object"==typeof e&&null!==e&&(e.choices||e.content||e.usage)){const t=e.model||"default",n=$(e,t),i=f(t,n.input,n.output);y(i).then(e=>{s.push({timestamp:Date.now(),model:t,cost:i,tokens:n}),w(),e>=o.limit&&b("COST LIMIT EXCEEDED")}).catch(e=>{console.warn("AgentGuard: Budget tracking failed:",e.message)})}}),p.log.apply(console,e)},function(){"undefined"!=typeof global&&global.fetch&&(global.fetch=k(global.fetch)),"undefined"!=typeof window&&window.fetch&&(window.fetch=k(window.fetch)),"undefined"!=typeof globalThis&&globalThis.fetch&&(globalThis.fetch=k(globalThis.fetch));try{const e=require("axios");e&&e.interceptors&&e.interceptors.response.use(e=>(e.config&&e.config.url&&x(e.config.url,e.data),e),e=>(e.response&&e.response.config&&x(e.response.config.url,e.response.data),Promise.reject(e)))}catch(e){}}(),setInterval(w,5e3),{getCost:()=>a?null:i,getLimit:()=>o.limit,setLimit:e=>{o.limit=e},setMode:e=>{o.mode=e},disable:()=>{o.enabled=!1},getLogs:()=>[...s],updatePrices:h,reset:async()=>{if(a)try{await a.del("agentguard:budget")}catch(e){console.warn("AgentGuard: Failed to reset Redis budget:",e.message)}i=0,s.length=0,w()}}}"undefined"!=typeof module&&module.exports&&(module.exports={init:E,updatePrices:h}),"undefined"!=typeof window&&(window.AgentGuard={init:E,updatePrices:h})}();