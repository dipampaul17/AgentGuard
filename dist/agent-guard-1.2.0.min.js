!function(){"use strict";let t,e;try{t=require("tiktoken")}catch(t){}try{e=require("@anthropic-ai/tokenizer")}catch(t){}let n={"gpt-4":{input:.03,output:.06},"gpt-4-turbo":{input:.01,output:.03},"gpt-3.5-turbo":{input:.0015,output:.002},"gpt-4o":{input:.0025,output:.01},"gpt-4o-mini":{input:15e-5,output:6e-4},"claude-3-opus":{input:.015,output:.075},"claude-3-sonnet":{input:.003,output:.015},"claude-3-haiku":{input:25e-5,output:.00125},"claude-3-5-sonnet":{input:.003,output:.015},default:{input:.01,output:.03}},o={limit:10,webhook:null,enabled:!0,silent:!1,mode:"throw",redis:null,privacy:!1},i=0,r=!1,s=0,c=null;const a=[],u="undefined"!=typeof require?require("fs"):null,l=("undefined"!=typeof require&&require("path"),".agentguard-cache.json"),p={red:"[31m",green:"[32m",yellow:"[33m",blue:"[34m",magenta:"[35m",cyan:"[36m",white:"[37m",reset:"[0m",bold:"[1m"},d={log:console.log,fetch:"undefined"!=typeof fetch?fetch:null,exit:"undefined"!=typeof process?process.exit:null};function g(t,e){if(t.includes("openai.com")){return e?.model||"gpt-3.5-turbo"}if(t.includes("anthropic.com")){return e?.model||"claude-3-haiku"}return"default"}function f(t,e=0,o=0){const i=n[t]||n.default;return e/1e3*i.input+o/1e3*i.output}function m(n,o="gpt-3.5-turbo"){if(!n)return 0;try{if(o.includes("gpt")&&t){return t.encoding_for_model(o.startsWith("gpt-4o")?"gpt-4o":o.startsWith("gpt-4")?"gpt-4":"gpt-3.5-turbo").encode(n).length}if(o.includes("claude")&&e)return e.encode(n).length}catch(t){console.warn("AgentGuard: Tokenizer error, falling back to estimation:",t.message)}const i=n.split(/\s+/).length,r=n.length;return Math.ceil(1.3*i+.25*r)}async function h(){if(d.fetch)try{if(u&&u.existsSync&&u.existsSync(l)){const t=JSON.parse(u.readFileSync(l,"utf8")),e=36e5;if(Date.now()-t.timestamp<e)return void(n={...n,...t.prices})}const t={timestamp:Date.now(),prices:{}};let e=!1;try{const n=await d.fetch("https://raw.githubusercontent.com/AgentOps-AI/tokencost/main/tokencost/costs.py",{timeout:1e4,headers:{"User-Agent":"AgentGuard/1.2.0"}});if(n.ok){const o=function(t){const e={};try{const n=t.split("\n");let o=!1;for(const t of n)if(t.includes("PRICING = {")||t.includes("model_prices = {"))o=!0;else{if(o&&t.includes("}"))break;if(o){const n=t.match(/"([^"]+)":\s*\{\s*"input":\s*([\d.]+),\s*"output":\s*([\d.]+)/);if(n){const[,t,o,i]=n;e[t]={input:parseFloat(o),output:parseFloat(i)}}}}}catch(t){console.warn("AgentGuard: Failed to parse Python costs:",t.message)}return e}(await n.text());Object.keys(o).length>0&&(t.prices={...t.prices,...o},e=!0)}}catch(t){console.warn("AgentGuard: Failed to fetch tokencost pricing:",t.message)}if(!e)try{const n=await d.fetch("https://api.github.com/repos/AgentOps-AI/tokencost/contents/tokencost/model_prices.json",{timeout:1e4,headers:{"User-Agent":"AgentGuard/1.2.0"}});if(n.ok){const o=await n.json(),i=JSON.parse(Buffer.from(o.content,"base64").toString());Object.entries(i).forEach(([e,n])=>{n.prompt_cost_per_1k&&n.completion_cost_per_1k&&(t.prices[e]={input:n.prompt_cost_per_1k,output:n.completion_cost_per_1k})}),e=!0}}catch(t){console.warn("AgentGuard: Failed to fetch GitHub pricing data:",t.message)}const o={"gpt-4":{input:.03,output:.06},"gpt-4-turbo":{input:.01,output:.03},"gpt-3.5-turbo":{input:.0015,output:.002},"gpt-4o":{input:.0025,output:.01},"gpt-4o-mini":{input:15e-5,output:6e-4},"claude-3-opus":{input:.015,output:.075},"claude-3-sonnet":{input:.003,output:.015},"claude-3-haiku":{input:25e-5,output:.00125},"claude-3-5-sonnet":{input:.003,output:.015},"claude-3-5-haiku":{input:.001,output:.005}};t.prices={...o,...t.prices},n={...n,...t.prices},u&&u.writeFileSync&&u.writeFileSync(l,JSON.stringify(t,null,2)),console.log(`AgentGuard: Updated pricing for ${Object.keys(t.prices).length} models`)}catch(t){console.warn("AgentGuard: Failed to update prices, using cached values:",t.message)}}async function y(t){if(c)try{const e="agentguard:budget",n=await c.incrByFloat(e,t);return await c.expire(e,86400),n}catch(e){return console.warn("AgentGuard: Redis increment failed, using local tracking:",e.message),i+=t,i}return i+=t,i}function $(t,e){try{if(t.usage)return{input:t.usage.prompt_tokens||t.usage.input_tokens||0,output:t.usage.completion_tokens||t.usage.output_tokens||0};if(t.choices&&t.choices.length>0){const n=t.choices[0];if(n.delta){return{input:0,output:m(n.delta.content||"",e)}}}if(t.content&&Array.isArray(t.content)){return{input:0,output:m(t.content.filter(t=>"text"===t.type).map(t=>t.text).join(""),e)}}if(t.choices?.[0]?.message){const n=t.choices[0].message;let o=0;return"string"==typeof n.content?o=m(n.content,e):Array.isArray(n.content)&&n.content.forEach(t=>{"text"===t.type?o+=m(t.text,e):"image_url"===t.type?o+=85:"audio"===t.type&&(o+=100)}),{input:Math.round(.2*o),output:Math.round(.8*o)}}const n=m(t.text||t.content||JSON.stringify(t).slice(0,1e3),e);return{input:Math.round(.3*n),output:Math.round(.7*n)}}catch(t){return console.warn("AgentGuard: Token extraction failed:",t.message),{input:50,output:50}}}function w(){const t=Date.now();if(t-s<100)return;if(s=t,o.silent)return;const e=i.toFixed(4),n=(i/o.limit*100).toFixed(1);let r="",c="";if(i>.9*o.limit?(r=`${p.red}${p.bold}$${e}${p.reset}`,c=` ${p.red}${p.bold}DANGER ${n}%${p.reset}`):i>.8*o.limit?(r=`${p.yellow}${p.bold}$${e}${p.reset}`,c=` ${p.yellow}WARNING ${n}%${p.reset}`):i>.5*o.limit?(r=`${p.cyan}$${e}${p.reset}`,c=` ${p.cyan}${n}%${p.reset}`):(r=`${p.green}$${e}${p.reset}`,c=` ${p.green}${n}%${p.reset}`),"undefined"!=typeof process){const t=`${r} / $${o.limit} ${c}`;process.stdout.write(`\r${t}${" ".repeat(Math.max(0,50-t.length))}`)}if("undefined"!=typeof document){let t=document.getElementById("agent-guard-widget");if(t||(t=document.createElement("div"),t.id="agent-guard-widget",t.style.cssText="\n          position: fixed; top: 20px; right: 20px; z-index: 99999;\n          background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);\n          color: #00ff88; padding: 12px 16px; border-radius: 8px;\n          font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;\n          font-size: 14px; font-weight: 600; letter-spacing: 0.5px;\n          box-shadow: 0 4px 20px rgba(0,0,0,0.3), 0 0 0 1px rgba(255,255,255,0.1);\n          border: 1px solid rgba(0,255,136,0.3);\n          transition: all 0.3s ease;\n        ",document.body.appendChild(t)),t.textContent=`$${e} / $${o.limit} (${n}%)`,i>.9*o.limit?(t.style.background="linear-gradient(135deg, #ff1744 0%, #f50057 100%)",t.style.color="#fff",t.style.borderColor="#ff1744",t.style.animation="pulse 1s infinite"):i>.8*o.limit&&(t.style.background="linear-gradient(135deg, #ff9800 0%, #f57c00 100%)",t.style.color="#fff",t.style.borderColor="#ff9800"),!document.getElementById("agentguard-styles")){const t=document.createElement("style");t.id="agentguard-styles",t.textContent="\n          @keyframes pulse {\n            0% { transform: scale(1); }\n            50% { transform: scale(1.05); }\n            100% { transform: scale(1); }\n          }\n        ",document.head.appendChild(t)}}}function b(t){if(r)return;r=!0;const e=Math.max(0,5*o.limit-i),n=`AGENTGUARD: ${t} - Saved you ~$${e.toFixed(2)}`;if(d.log(`\n${p.red}${p.bold}ðŸ›‘ ${n}${p.reset}`),d.log(`${p.cyan}ðŸ’° Total cost when stopped: $${i.toFixed(4)}${p.reset}`),d.log(`${p.yellow}ðŸ“Š Budget used: ${(i/o.limit*100).toFixed(1)}%${p.reset}`),async function(t){if(o.webhook)try{const e={text:t,timestamp:(new Date).toISOString(),cost:i,limit:o.limit};d.fetch&&await d.fetch(o.webhook,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}catch(t){d.log(`${p.red}AgentGuard: Webhook failed${p.reset}`,t.message)}}(n),"notify"===o.mode)return d.log(`${p.yellow}âš ï¸  Mode: notify - continuing execution with cost monitoring${p.reset}`),void d.log(`${p.cyan}ðŸ’¡ Tip: Set mode to 'throw' for safer error handling${p.reset}`);if("throw"===o.mode){d.log(`${p.green}ðŸ›¡ï¸  Mode: throw - gracefully stopping with recoverable error${p.reset}`);const t=new Error(`AGENTGUARD_LIMIT_EXCEEDED: ${n}`);throw t.agentGuardData={totalCost:i,limit:o.limit,percentUsed:i/o.limit*100,estimatedSavings:e,timestamp:Date.now()},t}if("kill"===o.mode)if(d.log(`${p.red}ðŸ’€ Mode: kill - terminating process immediately${p.reset}`),d.log(`${p.cyan}ðŸ’¡ Tip: Consider using mode 'throw' for graceful shutdown${p.reset}`),d.exit)setTimeout(()=>d.exit(1),100);else{if("undefined"==typeof window)throw new Error("AGENTGUARD_KILLED: "+n);alert(`${n}\nReloading page...`),window.location.reload()}}async function k(t,e){if(t&&(t.includes("openai.com")||t.includes("anthropic.com")||t.includes("api.anthropic.com")))try{const n=g(t,e),i=$(e,n),r=f(n,i.input,i.output),s=await y(r);a.push({timestamp:Date.now(),model:n,cost:r,tokens:i,url:t}),w(),s>=o.limit&&b("COST LIMIT EXCEEDED")}catch(t){y(.01).then(()=>w()).catch(()=>{})}}function x(t){return async function(e,n={}){const i=await t.call(this,e,n);if(e&&"string"==typeof e&&(e.includes("openai.com")||e.includes("anthropic.com")||e.includes("api.anthropic.com"))){const t=i.clone();try{const i=await t.json(),r=g(e,n.body?JSON.parse(n.body):{}),s=$(i,r),c=f(r,s.input,s.output),u=await y(c);a.push({timestamp:Date.now(),model:r,cost:c,tokens:s,url:e}),w(),u>=o.limit&&b("COST LIMIT EXCEEDED")}catch(t){y(.01).then(()=>w()).catch(()=>{})}}return i}}async function A(t={}){if(o={...o,...t},!o.enabled)return;await async function(){if(o.redis)try{const t=require("redis");c=t.createClient({url:o.redis}),await c.connect()}catch(t){console.warn("AgentGuard: Redis connection failed, using local tracking:",t.message),c=null}}(),await h();const e=`${p.green}${p.bold}AgentGuard${p.reset} ${p.cyan}v1.2.0${p.reset} ${p.green}initialized${p.reset}`,n=`${p.cyan}Budget protection: $${o.limit} (mode: ${o.mode})${p.reset}`,r=(p.dim||"")+"-".repeat(50)+(p.reset||"");return d.log("\n"+r),d.log(e),d.log(n),d.log(`${p.dim||""}Monitoring: console.log, fetch, axios${p.reset||""}`),o.redis&&d.log(`${p.dim||""}Multi-process: Redis enabled${p.reset||""}`),d.log(r+"\n"),console.log=function(...t){if(t.forEach(t=>{if("object"==typeof t&&null!==t&&(t.choices||t.content||t.usage)){const e=t.model||"default",n=$(t,e),i=f(e,n.input,n.output);y(i).then(r=>{a.push({timestamp:Date.now(),model:e,cost:i,tokens:n,source:"console",content:o.privacy?"[REDACTED]":t.choices?.[0]?.message?.content||t.content||"[no content]"}),w(),r>=o.limit&&b("COST LIMIT EXCEEDED")}).catch(t=>{console.warn("AgentGuard: Budget tracking failed:",t.message)})}}),o.privacy){const e=t.map(t=>"object"==typeof t&&null!==t&&(t.choices||t.content)?{...t,choices:"[REDACTED]",content:"[REDACTED]"}:t);d.log.apply(console,e)}else d.log.apply(console,t)},function(){"undefined"!=typeof global&&global.fetch&&(global.fetch=x(global.fetch)),"undefined"!=typeof window&&window.fetch&&(window.fetch=x(window.fetch)),"undefined"!=typeof globalThis&&globalThis.fetch&&(globalThis.fetch=x(globalThis.fetch));try{const t=require("axios");t&&t.interceptors&&t.interceptors.response.use(t=>(t.config&&t.config.url&&k(t.config.url,t.data),t),t=>(t.response&&t.response.config&&k(t.response.config.url,t.response.data),Promise.reject(t)))}catch(t){}try{const t=require("undici");if(t&&t.request){const e=t.request;t.request=function(t,n={}){const o=e.call(this,t,n);return"string"==typeof t&&(t.includes("openai.com")||t.includes("anthropic.com"))&&o.then(e=>{e.body.json().then(e=>{k(t,e)}).catch(()=>{})}).catch(()=>{}),o}}}catch(t){}try{const t=require("module"),e=t.prototype.require;t.prototype.require=function(t){const n=e.apply(this,arguments);if("got"===t&&n&&"function"==typeof n){const t=n;return function(...e){const n=t(...e);if(n&&n.then){const t=e[0];"string"==typeof t&&(t.includes("openai.com")||t.includes("anthropic.com"))&&n.then(e=>{let n=e.body;if("string"==typeof n)try{n=JSON.parse(n)}catch(t){}k(t,n)}).catch(()=>{})}return n}}return n}}catch(t){}try{[require("http"),require("https")].forEach(t=>{if(t&&t.request){const e=t.request;t.request=function(t,n){return t.hostname&&(t.hostname.includes("openai.com")||t.hostname.includes("anthropic.com"))||"string"==typeof t&&(t.includes("openai.com")||t.includes("anthropic.com"))?e.call(this,t,e=>{let o="";e.on("data",t=>o+=t),e.on("end",()=>{try{const e=JSON.parse(o);k("string"==typeof t?t:`${t.protocol||"https:"}//${t.hostname}${t.path||""}`,e)}catch(t){}}),n&&n(e)}):e.call(this,t,n)}}})}catch(t){}}(),setInterval(w,5e3),{getCost:()=>c?null:i,getLimit:()=>o.limit,setLimit:t=>{o.limit=t},setMode:t=>{o.mode=t},disable:()=>{o.enabled=!1,i=0,a.length=0},getLogs:()=>[...a],updatePrices:h,reset:async()=>{if(c)try{await c.del("agentguard:budget")}catch(t){console.warn("AgentGuard: Failed to reset Redis budget:",t.message)}i=0,a.length=0,w()}}}"undefined"!=typeof module&&module.exports&&(module.exports={init:A,updatePrices:h}),"undefined"!=typeof window&&(window.AgentGuard={init:A,updatePrices:h})}();